# Version Watcher

ä¸€ä¸ªè½»é‡çº§çš„å‰ç«¯ç‰ˆæœ¬ç›‘æ§å·¥å…·ï¼Œç”¨äºå®æ—¶æ£€æµ‹å’Œæç¤ºç½‘ç«™ç‰ˆæœ¬æ›´æ–°ã€‚

## ç‰¹æ€§

- ğŸš€ è‡ªåŠ¨æ£€æµ‹ç‰ˆæœ¬æ›´æ–°
- â° å¯é…ç½®çš„æ£€æŸ¥é—´éš”
- ğŸ”” è‡ªå®šä¹‰æ›´æ–°æç¤ºå†…å®¹
- ğŸ›¡ï¸ æ”¯æŒ JS é”™è¯¯ç›‘æ§
- ğŸŒ æ”¯æŒåŒæºé¡µé¢è‡ªåŠ¨åˆ·æ–°
- ğŸ¨ å¯è‡ªå®šä¹‰æç¤ºæ¡†æ ·å¼
- ğŸ“¦ æä¾›æ„å»ºå·¥å…·æ’ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯

## å®‰è£…

```bash
npm install version-watcher
```

## ä½¿ç”¨æ–¹æ³•

### å‰ç«¯ç›‘æ§

```javascript
import VersionWatcher from 'version-watcher'

// åŸºç¡€ä½¿ç”¨
new VersionWatcher()

// è‡ªå®šä¹‰é…ç½®
new VersionWatcher({
  endpoint: '/dist/version.json',  // ç‰ˆæœ¬ä¿¡æ¯æ¥å£
  interval: 5 * 60 * 1000,        // æ£€æŸ¥é—´éš”ï¼ˆé»˜è®¤5åˆ†é’Ÿï¼‰
  content: 'å‘ç°æ–°ç‰ˆæœ¬ï¼Œè¯·åˆ·æ–°é¡µé¢',  // è‡ªå®šä¹‰æç¤ºå†…å®¹
  disabled: false,                // æ˜¯å¦ç¦ç”¨æ›´æ–°æç¤º
  isListenJSError: false,        // æ˜¯å¦ç›‘å¬JSé”™è¯¯
  refreshSameOrigin: true        // æ˜¯å¦è‡ªåŠ¨åˆ·æ–°åŒæºé¡µé¢
})
```

### æ„å»ºå·¥å…·æ’ä»¶

åœ¨æ„å»ºå·¥å…·é…ç½®æ–‡ä»¶ä¸­ä½¿ç”¨æ’ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆå’Œæ›´æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼š

```javascript
// vite.config.js / vue.config.js
const { UpdateListenerPlugin } = require('version-watcher/plugin')

export default {
  plugins: [
    new UpdateListenerPlugin()
  ]
}
```

æ’ä»¶ä¼šåœ¨æ¯æ¬¡æ„å»ºæ—¶ï¼š
1. è‡ªåŠ¨è·å–æœ€æ–°çš„ Git æäº¤ä¿¡æ¯
2. ç”ŸæˆåŒ…å«ç‰ˆæœ¬ä¿¡æ¯çš„ JSON æ–‡ä»¶
3. ç¡®ä¿ç‰ˆæœ¬æ–‡ä»¶ä½äºæ­£ç¡®çš„æ„å»ºè¾“å‡ºç›®å½•

æ’ä»¶ç”Ÿæˆçš„ç‰ˆæœ¬ä¿¡æ¯æ ¼å¼å¦‚ä¸‹ï¼š

```json
{
  "version": "a1b2c3d",  // Git æœ€æ–°çš„ commit hash
  "isTip": true         // æ˜¯å¦æ˜¾ç¤ºæ›´æ–°æç¤º
}
```

> æç¤ºï¼šæ’ä»¶ä¼šè‡ªåŠ¨è·å– Git ä»“åº“æœ€æ–°çš„ commit hash ä½œä¸ºç‰ˆæœ¬å·ï¼Œæ¯æ¬¡ä»£ç æäº¤åæ„å»ºéƒ½ä¼šç”Ÿæˆæ–°çš„ç‰ˆæœ¬å·ï¼Œä»è€Œè§¦å‘ç”¨æˆ·ç«¯çš„æ›´æ–°æç¤ºã€‚

### æ‰‹åŠ¨ç»´æŠ¤ç‰ˆæœ¬ä¿¡æ¯

å¦‚æœä¸ä½¿ç”¨æ„å»ºå·¥å…·æ’ä»¶ï¼Œä½ éœ€è¦æ‰‹åŠ¨ç»´æŠ¤ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ–‡ä»¶è·¯å¾„ä¸º `/dist/version.json`ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```json
{
  "version": "1.0.0",     // ç‰ˆæœ¬å·
  "isTip": true          // æ˜¯å¦æ˜¾ç¤ºæ›´æ–°æç¤º
}
```

> æç¤ºï¼šversion çš„å€¼å¯ä»¥æ˜¯ä»»æ„å­—ç¬¦ä¸²ï¼Œåªè¦ä¸å½“å‰è®¿é—®é¡µé¢çš„ç‰ˆæœ¬ä¸åŒï¼Œå°±ä¼šè§¦å‘æ›´æ–°æç¤ºã€‚

## é…ç½®é€‰é¡¹

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| endpoint | String | '/dist/version.json' | ç‰ˆæœ¬ä¿¡æ¯æ¥å£åœ°å€ |
| interval | Number | 300000 | æ£€æŸ¥æ›´æ–°é—´éš”ï¼ˆæ¯«ç§’ï¼‰ |
| disabled | Boolean | false | æ˜¯å¦ç¦ç”¨æ›´æ–°æç¤º |
| isListenJSError | Boolean | false | æ˜¯å¦ç›‘å¬JSé”™è¯¯ |
| content | String | 'ä¸ºäº†æ›´å¥½çš„ç‰ˆæœ¬ä½“éªŒè¯·æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬' | æç¤ºæ¡†å†…å®¹ |
| dangerouslyUseHTMLString | Boolean | false | æ˜¯å¦å…è®¸å†…å®¹ä½¿ç”¨HTML |
| showTest | Boolean | false | æ˜¯å¦æ˜¾ç¤ºæµ‹è¯•å¼¹çª— |
| refreshSameOrigin | Boolean | true | æ˜¯å¦è‡ªåŠ¨åˆ·æ–°åŒæºé¡µé¢ |

## è‡ªå®šä¹‰æ›´æ–°æç¤º

å½“ `dangerouslyUseHTMLString` è®¾ç½®ä¸º `true` æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ HTML å­—ç¬¦ä¸²æ¥è‡ªå®šä¹‰æ›´æ–°æç¤ºçš„å†…å®¹å’ŒæŒ‰é’®ï¼š

```html
new VersionWatcher({
  content: `
    <div class="update-notification">
      <h3>å‘ç°æ–°ç‰ˆæœ¬</h3>
      <p>ç³»ç»Ÿå·²æ›´æ–°ï¼Œè¯·åˆ·æ–°ä½¿ç”¨æ–°ç‰ˆæœ¬ã€‚</p>
      <div class="buttons">
        <button id="VersionNotifierConfirm">ç«‹å³æ›´æ–°</button>
        <button id="VersionNotifierCancel">æš‚ä¸æ›´æ–°</button>
      </div>
    </div>
  `,
  dangerouslyUseHTMLString: true
})
```

### æŒ‰é’® ID è¯´æ˜

ä¸ºäº†ä½¿è‡ªå®šä¹‰çš„ HTML å†…å®¹èƒ½å¤Ÿæ­£ç¡®å“åº”ç”¨æˆ·æ“ä½œï¼Œéœ€è¦ä¸ºæŒ‰é’®å…ƒç´ æ·»åŠ ç‰¹å®šçš„ IDï¼š

- `VersionNotifierConfirm`: ç‚¹å‡»åç«‹å³åˆ·æ–°æ›´æ–°
- `VersionNotifierCancel`: ç‚¹å‡»åå…³é—­æç¤ºï¼Œæš‚ä¸æ›´æ–°

> æ³¨æ„ï¼šä½¿ç”¨ HTML å­—ç¬¦ä¸²æ—¶è¯·ç¡®ä¿å†…å®¹çš„å®‰å…¨æ€§ï¼Œé¿å… XSS é£é™©ã€‚

## å¼€å‘

```bash
# å®‰è£…ä¾èµ–
npm install

# å¼€å‘æ„å»º
npm run build
```

## License

[MIT](LICENSE)
